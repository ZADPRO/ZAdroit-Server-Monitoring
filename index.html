<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>API Status Logs</title>
    <style>
      body {
        font-family: system-ui, sans-serif;
        margin: 2rem;
        background: #fafafa;
      }
      h1 {
        margin-bottom: 1rem;
      }
      .filters {
        display: flex;
        gap: 1rem;
        margin-bottom: 1rem;
        flex-wrap: wrap;
      }
      .filters label {
        display: block;
        margin-bottom: 0.25rem;
        font-weight: bold;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        background: #fff;
        box-shadow: 0 2px 4px #0002;
      }
      th,
      td {
        padding: 0.75rem 1rem;
        border-bottom: 1px solid #eee;
        text-align: left;
      }
      th {
        background: #f3f4f6;
      }
      tr:last-child td {
        border-bottom: none;
      }
      .up {
        color: #2e7d32;
        font-weight: 600;
      }
      .down {
        color: #d32f2f;
        font-weight: 600;
      }
      .table-wrapper {
        max-height: 500px;
        overflow-y: auto;
        border: 1px solid #ddd;
        border-radius: 6px;
      }
      @media (max-width: 600px) {
        td:nth-child(3) {
          word-break: break-word;
        }
      }
    </style>
  </head>
  <body>
    <h1>üö¶ API Status Logs (Realtime)</h1>

    <div class="filters">
      <div>
        <label for="filter-date">Filter by Date:</label>
        <input type="date" id="filter-date" />
      </div>
      <div>
        <label for="filter-status">Filter by Status:</label>
        <select id="filter-status">
          <option value="">All</option>
          <option value="up">UP</option>
          <option value="down">DOWN</option>
        </select>
      </div>
    </div>

    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>Time (IST)</th>
            <th>Status</th>
            <th>Error Message</th>
          </tr>
        </thead>
        <tbody id="log-body"></tbody>
      </table>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
      import {
        getDatabase,
        ref,
        onValue,
      } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

      const firebaseConfig = {
        apiKey: "AIzaSyCJXcbU7R40OXlPdSzlcc3VRhgyGxV6DtQ", // ‚Üê Your API key here
        authDomain: "api-monitor-87868.firebaseapp.com",
        databaseURL:
          "https://api-monitor-87868-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "api-monitor-87868",
        storageBucket: "api-monitor-87868.firebasestorage.app",
        messagingSenderId: "857330399639",
        appId: "1:857330399639:web:5eecf7e35ff3c39a116cd2",
      };

      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);
      const tbody = document.getElementById("log-body");

      // Store full data for filtering
      let allLogs = [];

      function buildRow({ time, status, message }) {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${time}</td>
          <td class="${status === "up" ? "up" : "down"}">
            ${status === "up" ? "üü¢ UP" : "üî¥ DOWN"}
          </td>
          <td>${message || "-"}</td>
        `;
        return tr;
      }

      function renderTable(logs) {
        tbody.innerHTML = "";
        logs.forEach((log) => {
          tbody.appendChild(buildRow(log));
        });
      }

      function filterLogs() {
        const selectedDate = document.getElementById("filter-date").value;
        const selectedStatus = document.getElementById("filter-status").value;

        const filtered = allLogs.filter((log) => {
          const [day, month, year] = log.time.split(",")[0].split("/");
          const logDate = `${year}-${month.padStart(2, "0")}-${day.padStart(
            2,
            "0"
          )}`;
          const matchDate = selectedDate ? selectedDate === logDate : true;
          const matchStatus = selectedStatus
            ? selectedStatus === log.status
            : true;
          return matchDate && matchStatus;
        });

        renderTable(filtered);
      }

      // Listen to Firebase changes
      onValue(ref(db, "api-status-logs"), (snapshot) => {
        const rows = [];
        snapshot.forEach((child) => {
          const data = child.val();
          if (data && data.time && data.status) {
            rows.push(data);
          }
        });
        allLogs = rows.reverse();
        filterLogs(); // Apply filters after update
      });

      // Filter event listeners
      document
        .getElementById("filter-date")
        .addEventListener("input", filterLogs);
      document
        .getElementById("filter-status")
        .addEventListener("change", filterLogs);
    </script>
  </body>
</html>
